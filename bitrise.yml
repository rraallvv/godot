format_version: "4"

default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: other

trigger_map:
  - push_branch: '*'
    workflow: primary
  - pull_request_source_branch: '*'
    workflow: primary

app:
  envs:
    - SCONS_CACHE: $HOME/.scons_cache
    - SCONS_CACHE_LIMIT: 1024
    - CC: clang
    - CXX: clang++
    - GODOT_TARGET: osx
    - TOOLS: yes

workflows:
  primary:
    steps:
      - activate-ssh-key@3.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@3.6.2: {}
      - script@1.1.5:
          title: Do anything with Script step
      - deploy-to-bitrise-io@1.3.9: {}

  build:
    steps:
      - cache-pull: {}
      - script@1.1.5:
          title: Build script
          inputs:
            - content: |-
                mkdir -p $SCONS_CACHE
                misc/bitrise/scons-local-osx.sh
                scons -j 2 CC=$CC CXX=$CXX platform=$GODOT_TARGET TOOLS=$TOOLS verbose=yes progress=no;
      - cache-push:
          inputs:
            - cache_paths: |-
                $SCONS_CACHE
